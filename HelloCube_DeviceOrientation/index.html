<!DOCTYPE html>
<html lang="en">

<head>
    <title>Hello Cube app with Anaglyph and Orientation Sensing</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
    <link type="text/css" rel="stylesheet" href="main.css">
    <style>
        body {margin: 0;}
        canvas {width: 100%; height: 100%}
    </style>
</head>

<body>

<div id="overlay">
    <div>
        <button id="startButton">Start Demo</button>
        <p>Using device orientation might require a user interaction.</p>
    </div>
</div>
<div id="info">
    <a href="https://threejs.org" target="_blank" rel="noopener">three.js</a> - equirectangular panorama demo with DeviceOrientation controls.<br/>
    photo by <a href="http://www.flickr.com/photos/jonragnarsson/2294472375/" target="_blank" rel="noopener">JÃ³n Ragnarsson</a>.
</div>

<script type="module">

    import * as THREE from '../build/three.module.js';

    import { AnaglyphEffect } from './jsm/effects/AnaglyphEffect.js';

    import { DeviceOrientationControls } from './jsm/controls/DeviceOrientationControls.js';


    var scene, renderer, geometry, material, cube;

    var light_amb, light_dir, camera, effect, controls;

    var windowHalfX = window.innerWidth / 2;
    var windowHalfY = window.innerHeight / 2;
    var width = window.innerWidth || 2;
    var height = window.innerHeight || 2;

    var mouseX = 0;
    var mouseY = 0;


    var startButton = document.getElementById( 'startButton' );
    startButton.addEventListener( 'click', function () {

        init();
        animate();

    }, false );

    function init() {

        var overlay = document.getElementById( 'overlay' );
        overlay.remove();

        scene = new THREE.Scene();



        document.addEventListener( 'mousemove', onDocumentMouseMove, false );

        // Create the renderer
        renderer = new THREE.WebGLRenderer();
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);


        // TODO
        // Add the box to the scene. Play around with it to change stuffs
        geometry = new THREE.BoxGeometry(1, 2, 1);
        var material = new THREE.MeshBasicMaterial( {
            map: new THREE.TextureLoader().load( 'textures/2294472375_24a3b8ef46_o.jpg' )
        } );
        cube = new THREE.Mesh(geometry, material);
        scene.add(cube);

        // Create the ambient lighting of the scene
        light_amb = new THREE.AmbientLight(0x444444);
        scene.add(light_amb);

        // Create the direction of the lighting on the object
        light_dir = new THREE.DirectionalLight(0xdddddd, 0.8);
        light_dir.position.set( -5, 5, 5 );
        scene.add(light_dir);

        // Make the camera
        camera = new THREE.PerspectiveCamera( 50, window.innerWidth/window.innerHeight, 0.1, 1000 );
        camera.position.z = 5;
        scene.add(camera);

        // Make the controller orientation thingy
        controls = new DeviceOrientationControls( camera );

        // Create the custom anaglyph renderer
        effect = new AnaglyphEffect( renderer );
        effect.setSize( width, height );

        window.addEventListener( 'resize', onWindowResize, false );
    }

    function onDocumentMouseMove( event ) {

        mouseX = ( event.clientX - windowHalfX ) / 100;
        mouseY = ( event.clientY - windowHalfY ) / 100;

    }

    function onWindowResize() {

        windowHalfX = window.innerWidth / 2;
        windowHalfY = window.innerHeight / 2;

        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();

        effect.setSize( window.innerWidth, window.innerHeight );

    }

    function animate() {

        window.requestAnimationFrame(animate);

        controls.update();
        render();

    };

    function render() {

        var timer = 0.002 * Date.now();

        //controls.update();

        camera.lookAt( scene.position );

        cube.rotation.x += 0.001 * Math.cos(timer);
        cube.rotation.y += 0.01 * Math.sin(timer);

        light_dir.position.set( -Math.cos( timer ), 5, Math.cos( timer ) );

        renderer.render(scene, camera);
        effect.render( scene, camera );

    }


</script>

</body>

</html>